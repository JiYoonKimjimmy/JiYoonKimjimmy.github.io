I"m<blockquote>
  <p><a href="https://velog.io/@swchoi0329/NGINX-%EB%AC%B4%EC%A4%91%EB%8B%A8-%EB%B0%B0%ED%8F%AC">ì°¸ê³ . swchoi.log ë¸”ë¡œê·¸ [Nginx ë¬´ì¤‘ë‹¨ ë°°í¬]</a></p>
</blockquote>

<h2 id="nginx">Nginx</h2>
<p><code class="language-plaintext highlighter-rouge">Nginx(ì—”ì§„ì—‘ìŠ¤)</code> ëŠ” <strong>ë™ì‹œ ì ‘ì† ì²˜ë¦¬ì— íŠ¹í™”ëœ</strong> ì›¹ ì„œë²„ í”„ë¡œê·¸ë¨</p>
<ul>
  <li>Apache ë³´ë‹¤ëŠ” ë‹¨ìˆœí•˜ë©´ì„œ, ì „ë‹¬ì ì—­í• ë§Œ ìˆ˜í–‰í•˜ê¸° ë•Œë¬¸ì— ë™ì‹œ ì ‘ì† ì²˜ë¦¬ì— ìš©ì´</li>
  <li>ë¹„ë™ê¸° Event-Driven ê¸°ë°˜ êµ¬ì¡°</li>
  <li>Nginx ì˜ ì—­í• ë¡œì„œ,
    <ul>
      <li>ì •ì  íŒŒì¼ ì²˜ë¦¬ HTTP ì„œë²„ ì—­í• </li>
      <li>Reverse Proxy ì„œë²„ ì—­í• </li>
    </ul>
  </li>
</ul>

<p><strong>Reverse Proxy ì„œë²„?</strong>
Client ê°€ Server ë¡œ ìš”ì²­í•œ ê²½ìš°, Proxy ì„œë²„ <strong><em>(NGINX)</em></strong> ê°€ Reverse ì„œë²„ <strong><em>(Application)</em></strong> ë¡œë¶€í„° ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì—­í• ì„ í•œë‹¤.</p>

<p><strong>Event-Driven êµ¬ì¡°?</strong>
ì—¬ëŸ¬ Connection ì„ Event Handler ë¥¼ í†µí•´ ë¹„ë™ê¸° ë°©ì‹ìœ¼ë¡œ ì²˜ë¦¬
<img src="https://mblogthumb-phinf.pstatic.net/MjAxNzAzMjZfMTM3/MDAxNDkwNDk1NjMxNzgy.OHZ33nerX_6Hc92Mg_xjr51acwwi1P_mq3SIl7Cuhisg.niRsQQVM5CwGpXKcdOxl3bkNsmfBkqGV1ajcBpV6CvQg.GIF.jhc9639/mighttpd_e02.gif.gif?type=w800" alt="Event-Driven" /></p>

<h2 id="nginx-ë¬´ì¤‘ë‹¨-ë°°í¬">Nginx ë¬´ì¤‘ë‹¨ ë°°í¬</h2>
<h3 id="êµ¬ì„±">êµ¬ì„±</h3>
<ul>
  <li>Nginx 1ëŒ€
    <ul>
      <li>HTTP : 80 port</li>
      <li>HTTPS : 443 port</li>
    </ul>
  </li>
  <li>Spring Boot Application 2ëŒ€
    <ul>
      <li>Spring Boot 1 : 8081 port</li>
      <li>Spring Boot 2 : 8082 port</li>
    </ul>
  </li>
</ul>

<h3 id="1-nginx-ì„¤ì¹˜-ë°-spring-boot-ì—°ë™">1. Nginx ì„¤ì¹˜ ë° Spring Boot ì—°ë™</h3>
<h4 id="ec2-ì—-nginx-ì„¤ì¹˜">EC2 ì— Nginx ì„¤ì¹˜</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>yum <span class="nb">install </span>nginx
<span class="c"># nginx ì‹¤í–‰</span>
<span class="nv">$ </span><span class="nb">sudo </span>service nginx start
</code></pre></div></div>

<h4 id="ë³´ì•ˆ-ê·¸ë£¹-ì¶”ê°€">ë³´ì•ˆ ê·¸ë£¹ ì¶”ê°€</h4>
<ul>
  <li>ì¸ë°”ìš´ë“œ ê·œì¹™ &gt; <code class="language-plaintext highlighter-rouge">HTTP port 80</code> ì§€ì • ì•ˆë˜ì–´ ìˆëŠ” ê²½ìš° ì§€ì •</li>
  <li>EC2 domain ì£¼ì†Œ <strong>(port ì œì™¸)</strong> ì ‘ì† í™•ì¸</li>
</ul>

<h4 id="spring-boot--nginx">Spring Boot + Nginx</h4>
<p><strong><code class="language-plaintext highlighter-rouge">/etc/nginx/nginx.conf</code> ìˆ˜ì •</strong></p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">...
server <span class="o">{</span>
  ...
  location <span class="se">\ </span><span class="o">{</span>
    <span class="c"># Nginx ë¡œ ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´ í•´ë‹¹ ì£¼ì†Œë¡œ ì „ë‹¬</span>
    proxy_pass http://localhost:8080<span class="p">;</span>
    <span class="c"># ì‹¤ì œ ìš”ì²­ ë°ì´í„°ë¥¼ header ì˜ ê° í•­ëª©ì— í• ë‹¹</span>
    proxy_set_header X-Real-IP <span class="nv">$remote_addr</span><span class="p">;</span>
    proxy_set_header X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
    proxy_set_header Host <span class="nv">$http_host</span><span class="p">;</span>
  <span class="o">}</span>
  ...
<span class="o">}</span>
...</code></pre></figure>

<p><strong>Nginx ì¬ì‹œì‘</strong></p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>service nginx restart
</code></pre></div></div>

<p><strong>Spring Boot ì—°ë™ í™•ì¸</strong></p>
<ul>
  <li>í”„ë¡œì íŠ¸ Domain <strong>(port ì œì™¸)</strong> ì ‘ì† í™•ì¸</li>
</ul>

<h3 id="2-profile-api-ì¶”ê°€">2. Profile API ì¶”ê°€</h3>
<ul>
  <li>ì‹¤í–‰ì¤‘ì¸ profile ì¡°íšŒí•˜ê¸° ìœ„í•œ API</li>
</ul>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@RequiredArgsConstructor</span>
<span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"/profile"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ProfileController</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Environment</span> <span class="n">environment</span><span class="o">;</span>

    <span class="nd">@GetMapping</span>
    <span class="kd">public</span> <span class="nc">String</span> <span class="nf">profile</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// .getActiveProfiles() : í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ Active Profile ëª©ë¡ ì¡°íšŒ</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">profiles</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">environment</span><span class="o">.</span><span class="na">getActiveProfiles</span><span class="o">());</span>
        <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">realProfiles</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="s">"real"</span><span class="o">,</span> <span class="s">"real1"</span><span class="o">,</span> <span class="s">"real2"</span><span class="o">);</span>

        <span class="nc">String</span> <span class="n">defaultProfile</span> <span class="o">=</span> <span class="n">profiles</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()</span> <span class="o">?</span> <span class="s">"default"</span> <span class="o">:</span> <span class="n">profiles</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">profiles</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
                <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="nl">realProfiles:</span><span class="o">:</span><span class="n">contains</span><span class="o">)</span>
                <span class="o">.</span><span class="na">findAny</span><span class="o">()</span>
                <span class="o">.</span><span class="na">orElse</span><span class="o">(</span><span class="n">defaultProfile</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<h4 id="securityconfigurationjava-ìˆ˜ì •">SecurityConfiguration.java ìˆ˜ì •</h4>
<ul>
  <li><code class="language-plaintext highlighter-rouge">/profile</code> API security permission ìŠ¹ì¸ ì²˜ë¦¬</li>
</ul>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="o">...</span>
<span class="o">.</span><span class="na">antMatchers</span><span class="o">(</span><span class="s">"/*/sign/**"</span><span class="o">,</span> <span class="s">"/*/sign/*/**"</span><span class="o">,</span> <span class="s">"/social/**"</span><span class="o">,</span> <span class="s">"/profile"</span><span class="o">).</span><span class="na">permitAll</span><span class="o">()</span>
<span class="o">...</span></code></pre></figure>

<h3 id="3-profile-íŒŒì¼-ì¶”ê°€-ìƒì„±">3. Profile íŒŒì¼ ì¶”ê°€ ìƒì„±</h3>
<ul>
  <li>real1, real2 ê°ê° profile yml ìƒì„±</li>
</ul>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="c1"># application-real1.yml, application-real2.yml</span>
<span class="na">server</span><span class="pi">:</span>
  <span class="na">port</span><span class="pi">:</span> <span class="m">8081</span>        <span class="c1"># real2 ì¸ ê²½ìš°, 8082</span>

<span class="na">spring</span><span class="pi">:</span>
  <span class="na">profiles</span><span class="pi">:</span> <span class="s">real1</span>   <span class="c1"># real2 ì¸ ê²½ìš°, real2</span>
  <span class="na">url</span><span class="pi">:</span>
    <span class="na">base</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">Application Domain</span><span class="pi">]</span>

<span class="na">logging</span><span class="pi">:</span>
  <span class="na">level</span><span class="pi">:</span>
    <span class="na">root</span><span class="pi">:</span> <span class="s">warn</span>
    <span class="s">com.demo.restapi</span><span class="pi">:</span> <span class="s">info</span>
  <span class="na">file</span><span class="pi">:</span>
    <span class="na">path</span><span class="pi">:</span> <span class="s">/home/ec2-user/logs/rest-api</span>
    <span class="na">max-history</span><span class="pi">:</span> <span class="s">7</span></code></pre></figure>

<h3 id="4-nginx-ì„¤ì •-ìˆ˜ì •">4. Nginx ì„¤ì • ìˆ˜ì •</h3>
<h4 id="etcnginxconfdservice-urlinc-ìƒì„±"><code class="language-plaintext highlighter-rouge">/etc/nginx/conf.d/service-url.inc</code> ìƒì„±</h4>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">sudo </span>vi /etc/nginx/conf.d/service-url.inc

<span class="c"># service=url.inc</span>
<span class="nb">set</span> <span class="nv">$service_url</span> http://127.0.0.1:8080<span class="p">;</span></code></pre></figure>

<h4 id="etcnginxnginxconf-ìˆ˜ì •"><code class="language-plaintext highlighter-rouge">/etc/nginx/nginx.conf</code> ìˆ˜ì •</h4>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">...
server <span class="o">{</span>
  ...
  location <span class="se">\ </span><span class="o">{</span>
    <span class="c"># ì¶”ê°€</span>
    include /etc/nginx/conf.d/service-url.inc

    <span class="c"># http://localhost:8080 -&gt; $service_url ë¡œ ë³€ê²½</span>
    proxy_pass <span class="nv">$service_url</span><span class="p">;</span>
    proxy_set_header X-Real-IP <span class="nv">$remote_addr</span><span class="p">;</span>
    proxy_set_header X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
    proxy_set_header Host <span class="nv">$http_host</span><span class="p">;</span>
  <span class="o">}</span>
  ...
<span class="o">}</span>
...</code></pre></figure>

<p><strong>Nginx ì¬ì‹œì‘</strong></p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">sudo </span>service nginx restart</code></pre></figure>

<h3 id="5-deploy-script-ì¶”ê°€">5. Deploy Script ì¶”ê°€</h3>
<h4 id="ì¶”ê°€í• -scrpit-ëª©ë¡">ì¶”ê°€í•  Scrpit ëª©ë¡</h4>
<p>| script | ì„¤ì • |
| â€” | :â€”: |
| <code class="language-plaintext highlighter-rouge">profile.sh</code> | í˜„ì¬ profile ë²„ì „, port í™•ì¸ |
| <code class="language-plaintext highlighter-rouge">stop.sh</code> | ì‹¤í–‰ ì¤‘ì´ë˜ Spring Boot ì¢…ë£Œ |
| <code class="language-plaintext highlighter-rouge">start.sh</code> | ë°°í¬í•  Spring Boot ì¢…ë£Œ í›„ <code class="language-plaintext highlighter-rouge">profile.sh</code> ì‹¤í–‰ |
| <code class="language-plaintext highlighter-rouge">health.sh</code> | <code class="language-plaintext highlighter-rouge">start.sh</code> ë¡œ ì‹¤í–‰ëœ í”„ë¡œì íŠ¸ ì •ìƒ ë™ì‘ í™•ì¸ |
| <code class="language-plaintext highlighter-rouge">switch.sh</code> | Nginx ì˜ Spring Boot ë¥¼ ìµœì‹  profile ë²„ì „ìœ¼ë¡œ ë³€ê²½ |</p>

<h4 id="appspecyml-ìˆ˜ì •"><code class="language-plaintext highlighter-rouge">appspec.yml</code> ìˆ˜ì •</h4>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">hooks</span><span class="pi">:</span>
  <span class="c1"># Nginx ì™€ ì—°ë™ëœ Spring Boot í”„ë¡œì íŠ¸ ì¢…ë£Œ</span>
  <span class="na">AfterInstall</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">location</span><span class="pi">:</span> <span class="s">stop.sh</span>
      <span class="na">timeout</span><span class="pi">:</span> <span class="m">60</span>
      <span class="na">runas</span><span class="pi">:</span> <span class="s">ec2-user</span>
  <span class="c1"># Nginx ì™€ ì—°ë™ì•ˆëœ profile ë²„ì „ìœ¼ë¡œ Spring Boot ì‹¤í–‰</span>
  <span class="na">ApplicationStart</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">location</span><span class="pi">:</span> <span class="s">start.sh</span>
      <span class="na">timeout</span><span class="pi">:</span> <span class="m">60</span>
      <span class="na">runas</span><span class="pi">:</span> <span class="s">ec2-user</span>
  <span class="c1"># ìƒˆë¡œ ì‹¤í–‰ëœ Spring Boot ì •ìƒ ë™ì‘ í™•ì¸</span>
  <span class="na">ValidateService</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">location</span><span class="pi">:</span> <span class="s">health.sh</span>
      <span class="na">timeout</span><span class="pi">:</span> <span class="m">60</span>
      <span class="na">runas</span><span class="pi">:</span> <span class="s">ec2-user</span></code></pre></figure>

<h4 id="profilesh"><code class="language-plaintext highlighter-rouge">profile.sh</code></h4>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/usr/bin/env bash</span>

<span class="c"># ì‰¬ê³  ìˆëŠ” profile ì°¾ê¸°</span>
<span class="k">function </span>find_idle_profile<span class="o">()</span> <span class="o">{</span>
  <span class="c"># í˜„ì¬ Nginx ì™€ ì—°ë™ëœ í”„ë¡œì íŠ¸ê°€ ì •ìƒì ì¸ì§€ í™•ì¸</span>
  <span class="c"># RESPONSE_CODE ëŠ” HTTP status code ë¡œ ë°˜í™˜</span>
  <span class="nv">RESPONSE_CODE</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> <span class="nt">-o</span> /dev/null <span class="nt">-w</span> <span class="s2">"%{http_code}"</span> http://localhost/profile<span class="si">)</span>

  <span class="c"># í”„ë¡œì íŠ¸ ìƒíƒœê°€ 400 ë³´ë‹¤ í° ê²½ìš°, ì—ëŸ¬</span>
  <span class="k">if</span> <span class="o">[</span> <span class="k">${</span><span class="nv">RESPONSE_CODE</span><span class="k">}</span> <span class="nt">-ge</span> 400 <span class="o">]</span>
  <span class="k">then
    </span><span class="nv">CURRENT_PROFILE</span><span class="o">=</span>real2
  <span class="k">else
    </span><span class="nv">CURRENT_PROFILE</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> http://localhost/profile<span class="si">)</span>
  <span class="k">fi

  if</span> <span class="o">[</span> <span class="k">${</span><span class="nv">CURRENT_PROFILE</span><span class="k">}</span> <span class="o">==</span> real1 <span class="o">]</span>
  <span class="k">then
    </span><span class="nv">IDLE_PROFILE</span><span class="o">=</span>real2
  <span class="k">else
    </span><span class="nv">IDLE_PROFILE</span><span class="o">=</span>real1
  <span class="k">fi

  </span><span class="nb">echo</span> <span class="s2">"</span><span class="k">${</span><span class="nv">IDLE_PROFILE</span><span class="k">}</span><span class="s2">"</span>
<span class="o">}</span>

<span class="c"># ì‰¬ê³  ìˆëŠ” profile ì˜ port ì°¾ê¸°</span>
<span class="k">function </span>find_idle_port<span class="o">()</span> <span class="o">{</span>
  <span class="nv">IDLE_PROFILE</span><span class="o">=</span><span class="si">$(</span>find_idle_profile<span class="si">)</span>

  <span class="k">if</span> <span class="o">[</span> <span class="k">${</span><span class="nv">IDLE_PROFILE</span><span class="k">}</span> <span class="o">==</span> real1 <span class="o">]</span>
  <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"8081"</span>
  <span class="k">else
    </span><span class="nb">echo</span> <span class="s2">"8082"</span>
  <span class="k">fi</span>
<span class="o">}</span></code></pre></figure>

<h4 id="stopsh"><code class="language-plaintext highlighter-rouge">stop.sh</code></h4>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/usr/bin/env bash</span>

<span class="nv">ABSPATH</span><span class="o">=</span><span class="si">$(</span><span class="nb">readlink</span> <span class="nt">-f</span> <span class="nv">$0</span><span class="si">)</span>
<span class="nv">ABSDIR</span><span class="o">=</span><span class="si">$(</span><span class="nb">dirname</span> <span class="nv">$ABSPATH</span><span class="si">)</span>
<span class="nb">source</span> <span class="k">${</span><span class="nv">ABSDIR</span><span class="k">}</span>/profile.sh

<span class="nv">IDLE_PORT</span><span class="o">=</span><span class="si">$(</span>find_idle_port<span class="si">)</span>

<span class="nb">echo</span> <span class="s2">"&gt; </span><span class="nv">$IDLE_PORT</span><span class="s2"> ì—ì„œ êµ¬ë™ ì¤‘ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ pid í™•ì¸"</span>
<span class="nv">IDLE_PID</span><span class="o">=</span><span class="si">$(</span>lsof <span class="nt">-ti</span> tcp:<span class="k">${</span><span class="nv">IDLE_PORT</span><span class="k">}</span><span class="si">)</span>

<span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="k">${</span><span class="nv">IDLE_PID</span><span class="k">}</span> <span class="o">]</span>
<span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"&gt; í˜„ì¬ êµ¬ë™ ì¤‘ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì—†ìœ¼ë¯€ë¡œ ì¢…ë£Œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."</span>
<span class="k">else
  </span><span class="nb">echo</span> <span class="s2">"&gt; kill -15 </span><span class="nv">$IDLE_PID</span><span class="s2">"</span>
  <span class="nb">kill</span> <span class="nt">-15</span> <span class="k">${</span><span class="nv">IDLE_PID</span><span class="k">}</span>
  <span class="nb">sleep </span>5
<span class="k">fi</span></code></pre></figure>

<h4 id="startsh"><code class="language-plaintext highlighter-rouge">start.sh</code></h4>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/usr/bin/env bash</span>

<span class="nv">ABSPATH</span><span class="o">=</span><span class="si">$(</span><span class="nb">readlink</span> <span class="nt">-f</span> <span class="nv">$0</span><span class="si">)</span>
<span class="nv">ABSDIR</span><span class="o">=</span><span class="si">$(</span><span class="nb">dirname</span> <span class="nv">$ABSPATH</span><span class="si">)</span>
<span class="nb">source</span> <span class="k">${</span><span class="nv">ABSDIR</span><span class="k">}</span>/profile.sh

<span class="nv">REPOSITORY</span><span class="o">=</span>/home/ec2-user/apps
<span class="nv">DEPLOY_DIRECTORY</span><span class="o">=</span>/home/ec2-user/deploy
<span class="nv">PROJECT_NAME</span><span class="o">=</span>rest-api

<span class="nb">echo</span> <span class="s2">"&gt; old íŒŒì¼ ì´ë™"</span>
<span class="nb">mv</span> <span class="nv">$REPOSITORY</span>/<span class="nv">$PROJECT_NAME</span>/<span class="k">*</span>.jar <span class="nv">$REPOSITORY</span>/<span class="nv">$PROJECT_NAME</span>/old/

<span class="nb">echo</span> <span class="s2">"&gt; Build íŒŒì¼ ë³µì‚¬"</span>
<span class="nb">cp</span> <span class="nv">$DEPLOY_DIRECTORY</span>/<span class="nv">$PROJECT_NAME</span>/<span class="k">*</span>.jar <span class="nv">$REPOSITORY</span>/<span class="nv">$PROJECT_NAME</span>/

<span class="nb">echo</span> <span class="s2">"&gt; ìƒˆ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬"</span>
<span class="nv">JAR_NAME</span><span class="o">=</span><span class="si">$(</span><span class="nb">ls</span> <span class="nt">-tr</span> <span class="nv">$REPOSITORY</span>/<span class="nv">$PROJECT_NAME</span>/<span class="k">*</span>.jar | <span class="nb">tail</span> <span class="nt">-n</span> 1<span class="si">)</span>

<span class="nb">echo</span> <span class="s2">"&gt; JAR Name: </span><span class="nv">$JAR_NAME</span><span class="s2">"</span>

<span class="nb">echo</span> <span class="s2">"&gt; </span><span class="nv">$JAR_NAME</span><span class="s2"> ì— ì‹¤í–‰ê¶Œí•œ ì¶”ê°€"</span>
<span class="nb">chmod</span> +x <span class="nv">$JAR_NAME</span>

<span class="nb">echo</span> <span class="s2">"&gt; </span><span class="nv">$JAR_NAME</span><span class="s2"> ì‹¤í–‰"</span>
<span class="nv">IDLE_PROFILE</span><span class="o">=</span><span class="si">$(</span>find_idle_profile<span class="si">)</span>

<span class="nb">echo</span> <span class="s2">"&gt; </span><span class="nv">$JAR_NAME</span><span class="s2"> ë¥¼ profile=</span><span class="nv">$IDLE_PROFILE</span><span class="s2"> ë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤."</span>
<span class="nb">nohup </span>java <span class="nt">-jar</span> <span class="se">\</span>
    <span class="nt">-Dspring</span>.config.location<span class="o">=</span>classpath:/application.yml,classpath:/application-<span class="nv">$IDLE_PROFILE</span>.yml,/home/ec2-user/apps/config/application-db.yml <span class="se">\</span>
    <span class="nt">-Dspring</span>.profiles.active<span class="o">=</span><span class="nv">$IDLE_PROFILE</span> <span class="se">\</span>
    <span class="nt">-Dfile</span>.encoding<span class="o">=</span>UTF-8 <span class="se">\</span>
    <span class="nv">$JAR_NAME</span> <span class="o">&gt;</span> <span class="nv">$REPOSITORY</span>/<span class="nv">$PROJECT_NAME</span>/nohup.out 2&gt;&amp;1 &amp;</code></pre></figure>

<h4 id="healthsh"><code class="language-plaintext highlighter-rouge">health.sh</code></h4>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/usr/bin/env bash</span>

<span class="nv">ABSPATH</span><span class="o">=</span><span class="si">$(</span><span class="nb">readlink</span> <span class="nt">-f</span> <span class="nv">$0</span><span class="si">)</span>
<span class="nv">ABSDIR</span><span class="o">=</span><span class="si">$(</span><span class="nb">dirname</span> <span class="nv">$ABSPATH</span><span class="si">)</span>
<span class="nb">source</span> <span class="k">${</span><span class="nv">ABSDIR</span><span class="k">}</span>/profile.sh
<span class="nb">source</span> <span class="k">${</span><span class="nv">ABSDIR</span><span class="k">}</span>/switch.sh

<span class="nv">IDLE_PORT</span><span class="o">=</span><span class="si">$(</span>find_idle_port<span class="si">)</span>

<span class="nb">echo</span> <span class="s2">"&gt; Health Check Start!"</span>
<span class="nb">echo</span> <span class="s2">"&gt; IDLE_PORT: </span><span class="nv">$IDLE_PORT</span><span class="s2">"</span>
<span class="nb">echo</span> <span class="s2">"&gt; curl -s http://localhost:</span><span class="nv">$IDLE_PORT</span><span class="s2">/profile"</span>
<span class="nb">sleep </span>10

<span class="k">for </span>RETRY_COUNT <span class="k">in</span> <span class="o">{</span>1..10<span class="o">}</span>
<span class="k">do
  </span><span class="nv">RESPONSE</span><span class="o">=</span><span class="si">$(</span>curl <span class="nt">-s</span> http://localhost:<span class="k">${</span><span class="nv">IDLE_PORT</span><span class="k">}</span>/profile<span class="si">)</span>
  <span class="nv">UP_COUNT</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="k">${</span><span class="nv">RESPONSE</span><span class="k">}</span> | <span class="nb">grep</span> <span class="s1">'real'</span> | <span class="nb">wc</span> <span class="nt">-l</span><span class="si">)</span>

  <span class="c"># $UP_COUNT &gt;= 1 ("real" ë¬¸ìì—´ì´ ìˆëŠ”ì§€ ê²€ì¦)</span>
  <span class="k">if</span> <span class="o">[</span> <span class="k">${</span><span class="nv">UP_COUNT</span><span class="k">}</span> <span class="nt">-ge</span> 1 <span class="o">]</span>
  <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"&gt; Health check ì„±ê³µ"</span>
    switch_proxy
    <span class="nb">break
  </span><span class="k">else
    </span><span class="nb">echo</span> <span class="s2">"&gt; Health checkì˜ ì‘ë‹µì„ ì•Œ ìˆ˜ ì—†ê±°ë‚˜ í˜¹ì€ ì‹¤í–‰ ìƒíƒœê°€ ì•„ë‹™ë‹ˆë‹¤."</span>
    <span class="nb">echo</span> <span class="s2">"&gt; Health check: </span><span class="k">${</span><span class="nv">RESPONSE</span><span class="k">}</span><span class="s2">"</span>
  <span class="k">fi

  if</span> <span class="o">[</span> <span class="k">${</span><span class="nv">RETRY_COUNT</span><span class="k">}</span> <span class="nt">-eq</span> 10 <span class="o">]</span>
  <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"&gt; Health check ì‹¤íŒ¨. "</span>
    <span class="nb">echo</span> <span class="s2">"&gt; ì—”ì§„ì—‘ìŠ¤ì— ì—°ê²°í•˜ì§€ ì•Šê³  ë°°í¬ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤."</span>
    <span class="nb">exit </span>1
  <span class="k">fi

  </span><span class="nb">echo</span> <span class="s2">"&gt; Health check ì—°ê²° ì‹¤íŒ¨. ì¬ì‹œë„..."</span>
  <span class="nb">sleep </span>10
<span class="k">done</span></code></pre></figure>

<h4 id="switchsh"><code class="language-plaintext highlighter-rouge">switch.sh</code></h4>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/usr/bin/env bash</span>

<span class="nv">ABSPATH</span><span class="o">=</span><span class="si">$(</span><span class="nb">readlink</span> <span class="nt">-f</span> <span class="nv">$0</span><span class="si">)</span>
<span class="nv">ABSDIR</span><span class="o">=</span><span class="si">$(</span><span class="nb">dirname</span> <span class="nv">$ABSPATH</span><span class="si">)</span>
<span class="nb">source</span> <span class="k">${</span><span class="nv">ABSDIR</span><span class="k">}</span>/profile.sh

<span class="k">function </span>switch_proxy<span class="o">()</span> <span class="o">{</span>
  <span class="nv">IDLE_PORT</span><span class="o">=</span><span class="si">$(</span>find_idle_port<span class="si">)</span>

  <span class="nb">echo</span> <span class="s2">"&gt; ì „í™˜í•  Port: </span><span class="nv">$IDLE_PORT</span><span class="s2">"</span>
  <span class="nb">echo</span> <span class="s2">"&gt; Port ì „í™˜"</span>

  <span class="c"># Nginx ê°€ ë³€ê²½í•  Proxy ì£¼ì†Œë¥¼ ìƒì„± í›„, service-url.inc ì— over-write</span>
  <span class="nb">echo</span> <span class="s2">"set </span><span class="se">\$</span><span class="s2">service_url http://127.0.0.1:</span><span class="k">${</span><span class="nv">IDLE_PORT</span><span class="k">}</span><span class="s2">;"</span> | <span class="nb">sudo tee</span> /etc/nginx/conf.d/service-url.inc

  <span class="nb">echo</span> <span class="s2">"&gt; ì—”ì§„ì—‘ìŠ¤ Reload"</span>

  <span class="c"># Nginx ì„¤ì • reload(ëŠê¹€ ì—†ì´ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜´)</span>
  <span class="nb">sudo </span>service nginx reload
<span class="o">}</span></code></pre></figure>

<h3 id="ë¬´ì¤‘ë‹¨-ë°°í¬-í™•ì¸">ë¬´ì¤‘ë‹¨ ë°°í¬ í™•ì¸</h3>
<h4 id="buildgradle-ìˆ˜ì •"><code class="language-plaintext highlighter-rouge">build.gradle</code> ìˆ˜ì •</h4>

<figure class="highlight"><pre><code class="language-groovy" data-lang="groovy"><span class="n">version</span> <span class="o">=</span> <span class="s1">'0.0.1-SNAPSHOT-'</span> <span class="o">+</span> <span class="k">new</span> <span class="n">Date</span><span class="o">().</span><span class="na">format</span><span class="o">(</span><span class="s2">"yyyyMMddHHmmss"</span><span class="o">)</span></code></pre></figure>

<h4 id="log-í™•ì¸">Log í™•ì¸</h4>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># CodeDeploy Log</span>
<span class="nv">$ </span>vi /opt/codedeploy-agent/deploayment-root/deployment-logs
<span class="c"># Spring Boot log</span>
<span class="nv">$ </span>vi nohup.out
<span class="c"># Java application ì‹¤í–‰ ì—¬ë¶€ í™•ì¸</span>
<span class="nv">$ </span>ps <span class="nt">-ef</span> | <span class="nb">grep </span>java</code></pre></figure>

<hr />

<p><a href="https://github.com/JiYoonKimjimmy/demo-rest-api">ê´€ë ¨ Github Repository</a></p>
:ET