I"‹C<h2 id="spring-security">Spring Security?</h2>
<ul>
  <li>ì¸ì¦ ë° ê¶Œí•œ ë¶€ì—¬ë¥¼ í†µí•´ resourceë¥¼ ì‰½ê²Œ ì œì–´í•  ìˆ˜ ìˆëŠ” Springì˜ Framework</li>
  <li>DispatcherServlet ì•ì—ì„œ Filterë¥¼ ë“±ë¡í•˜ì—¬ ìš”ì²­ì„ ë¨¼ì € í™•ì¸</li>
</ul>

<h2 id="jwt-json-web-token">JWT <strong><em>(JSON Web Token)</em></strong></h2>
<h3 id="íŠ¹ì§•">íŠ¹ì§•</h3>
<ul>
  <li><strong>ì›¹ í‘œì¤€ ê¸°ë°˜</strong> <strong><em>(RFC 7519)</em></strong> ì˜ ë‹¤ì–‘í•œ í™˜ê²½ ì§€ì›ì´ ê°€ëŠ¥</li>
  <li><strong>Self-Contained</strong> <strong><em>(ìê°€ ìˆ˜ìš©ì )</em></strong> ìœ¼ë¡œì„œ JWT ìì²´ê°€ ëª¨ë“  ì •ë³´ë¥¼ í¬í•¨</li>
  <li>ìê°€ ìˆ˜ìš©ì ì¸ íŠ¹ì„±ì„ ì´ìš©í•´ <strong>ì „ë‹¬ ë°©ì‹ì´ ë¹„êµì  ê°„í¸</strong>(Header í¬í•¨ or URL param ì „ë‹¬ ê°€ëŠ¥)</li>
</ul>

<h3 id="jwtì˜-êµ¬ì¡°">JWTì˜ êµ¬ì¡°</h3>
<h3 id="headerpayloadsignature">[Header].[Payload].[Signature]</h3>
<h4 id="header">Header</h4>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="p">{</span>
  <span class="dl">"</span><span class="s2">typ</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">JWT</span><span class="dl">"</span><span class="p">,</span>     <span class="c1">// "typ" : token íƒ€ì… ì •ì˜</span>
  <span class="dl">"</span><span class="s2">alg</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">HS256</span><span class="dl">"</span>    <span class="c1">// "alg" : í•´ì‹± ì•Œê³ ë¦¬ì¦˜ ì§€ì •</span>
<span class="p">}</span>
<span class="c1">// JSON stringì„ base 64ë¡œ Encoding ì²˜ë¦¬</span></code></pre></figure>

<h4 id="payload">Payload</h4>
<p>Payload ë¶€ë¶„ì€ Tokenì— ë‹´ì„ ì •ë³´(Claim)ë“¤ì„ í¬í•¨</p>
<ul>
  <li>Registerd(ë“±ë¡ëœ) Claim : ì´ë¯¸ ì •í•´ì ¸ìˆëŠ” Token ì •ë³´</li>
</ul>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="p">{</span>
  <span class="dl">"</span><span class="s2">iss</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">jwttest.com</span><span class="dl">"</span><span class="p">,</span>    <span class="c1">// Token ë°œê¸‰ì</span>
  <span class="dl">"</span><span class="s2">sub</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">jwttest</span><span class="dl">"</span><span class="p">,</span>        <span class="c1">// Token ì œëª©</span>
  <span class="dl">"</span><span class="s2">aud</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">jwtuser</span><span class="dl">"</span><span class="p">,</span>        <span class="c1">// Token ëŒ€ìƒì</span>
  <span class="dl">"</span><span class="s2">exp</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">20200090150630</span><span class="dl">"</span><span class="p">,</span> <span class="c1">// ë§Œë£Œ ë‚ ì§œë¡œì„œ í˜„ì¬ ë‚ ì§œ ì´í›„ë¡œ ì§€ì • ê°€ëŠ¥(NumericDate)</span>
  <span class="dl">"</span><span class="s2">nbf</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">20200831160000</span><span class="dl">"</span><span class="p">,</span> <span class="c1">// í™œì„±í™” ë‚ ì§œë¡œì„œ í•´ë‹¹ ë‚ ì§œê°€ ì§€ë‚˜ì•¼ Token ì²˜ë¦¬ ê°€ëŠ¥(NumericDate)</span>
  <span class="dl">"</span><span class="s2">iat</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">20200831150630</span><span class="dl">"</span><span class="p">,</span> <span class="c1">// ë°œê¸‰ ë‚ ì§œ(issued at)ë¡œì„œ Tokenì˜ ageë¥¼ íŒë‹¨ ê°€ëŠ¥(NumericDate)</span>
  <span class="dl">"</span><span class="s2">jti</span><span class="dl">"</span><span class="p">:</span> <span class="dl">""</span>                <span class="c1">// JWTì˜ ê³ ìœ  ì‹ë³„ìë¡œì„œ ì¼íšŒìš© Token ì‚¬ìš©í•  ë•Œ ìœ ìš©</span>
<span class="p">}</span>
<span class="c1">// JSON stringì„ base 64ë¡œ Encoding ì²˜ë¦¬</span></code></pre></figure>

<ul>
  <li>Public(ê³µê°œ) Claim : ì¶©ëŒ ë°©ì§€ëœ(Collision-Resistant) ì´ë¦„ í˜•ì‹ì¸ URL í˜•ì‹ì„ ìê¸°ê³  ìˆëŠ” ì •ë³´</li>
</ul>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="p">{</span>
  <span class="p">...</span>
  <span class="dl">"</span><span class="s2">https://jwttest.com</span><span class="dl">"</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">...</span>
<span class="p">}</span>
<span class="c1">// JSON stringì„ base 64ë¡œ Encoding ì²˜ë¦¬</span></code></pre></figure>

<ul>
  <li>Private(ë¹„ê³µê°œ) Claim : Registerd ë‚˜ Public ì´ ì•„ë‹Œ ì •ë³´(ì¶©ëŒ ê°€ëŠ¥)</li>
</ul>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="p">{</span>
  <span class="p">...</span>
  <span class="dl">"</span><span class="s2">username</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">jwtest</span><span class="dl">"</span>
  <span class="p">...</span>
<span class="p">}</span>
<span class="c1">// JSON stringì„ base 64ë¡œ Encoding ì²˜ë¦¬</span></code></pre></figure>

<h4 id="signature">Signature</h4>
<p>Header ì™€ Payload ê°’ì„ ì¸ì½”ë”©í•œ í›„ ê²°í•©í•˜ì—¬, ë¹„ë°€í‚¤ë¡œ Hashí•˜ì—¬ ìƒì„±í•œ ê°’</p>

<figure class="highlight"><pre><code class="language-js" data-lang="js"><span class="kd">const</span> <span class="nx">jwt</span> <span class="o">=</span> <span class="nx">base64UrlEncode</span><span class="p">(</span><span class="nx">header</span><span class="p">)</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">.</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">base64UrlEncode</span><span class="p">(</span><span class="nx">payload</span><span class="p">);</span>
<span class="nx">HMACSHA256</span><span class="p">(</span><span class="nx">jwt</span><span class="p">,</span> <span class="nx">secret</span><span class="p">)</span></code></pre></figure>

<h2 id="jwt-êµ¬í˜„">JWT êµ¬í˜„</h2>
<h4 id="jwttokenprovider">JwtTokenProvider</h4>
<ul>
  <li>JWT Token ìƒì„± ë° ìœ íš¨ì„± ê²€ì¦ì„ ìœ„í•œ Component ì—­í• </li>
</ul>

<h4 id="jwtauthenticationfilter">JwtAuthenticationFilter</h4>
<ul>
  <li>ìš”ì²­ìœ¼ë¡œ ë“¤ì–´ì˜¨ Tokenì˜ ìœ íš¨ì„± ì¸ì¦ì„ ìœ„í•œ Filter ì—­í• </li>
  <li>Security ì„¤ì • ì‹œ, UsernamePasswordAuthenticationFilter ì•ì— ì„¤ì •</li>
</ul>

<h4 id="securityconfiguration">SecurityConfiguration</h4>
<ul>
  <li>ì„œë²„ì˜ ë³´ì•ˆ ì„¤ì •ì„ í•˜ëŠ” Configuration ì—­í• </li>
</ul>

<p><strong>Resource ì ‘ê·¼ ì œí•œ í‘œí˜„ì‹</strong></p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">í‘œí˜„ì‹</th>
      <th style="text-align: center">ì˜ë¯¸</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">hasIpAddress</td>
      <td style="text-align: center">IPì£¼ì†Œê°€ ë§¤ì¹­í•  ê²½ìš°</td>
    </tr>
    <tr>
      <td style="text-align: center">hasRole</td>
      <td style="text-align: center">ì—­í• ì´ ë¶€ì—¬í•œ ê¶Œí•œê³¼ ì¼ì¹˜í•œ ê²½ìš°</td>
    </tr>
    <tr>
      <td style="text-align: center">hasAnyRole</td>
      <td style="text-align: center">ë¶€ì—¬ëœ ì—­í•  ì¤‘ ì¼ì¹˜í•œ í•­ëª©ì´ ìˆëŠ” ê²½ìš°</td>
    </tr>
    <tr>
      <td style="text-align: center">permitAll</td>
      <td style="text-align: center">ëª¨ë“  ì ‘ê·¼ ìŠ¹ì¸</td>
    </tr>
    <tr>
      <td style="text-align: center">denyAll</td>
      <td style="text-align: center">ëª¨ë“  ì ‘ê·¼ ê±°ë¶€</td>
    </tr>
    <tr>
      <td style="text-align: center">anonymous</td>
      <td style="text-align: center">ìµëª…ì˜ ì‚¬ìš©ìì¸ì§€ í™•ì¸</td>
    </tr>
    <tr>
      <td style="text-align: center">authenticated</td>
      <td style="text-align: center">ì¸ì¦ëœ ì‚¬ìš©ìì¸ì§€ í™•ì¸</td>
    </tr>
    <tr>
      <td style="text-align: center">rememberMe</td>
      <td style="text-align: center">ì‚¬ìš©ìê°€ â€˜remember meâ€™ ì‚¬ìš©í•´ ì¸ì¦ì¸ì§€ í™•ì¸</td>
    </tr>
    <tr>
      <td style="text-align: center">fullyAuthenticated</td>
      <td style="text-align: center">ì‚¬ìš©ìê°€ ëª¨ë“  Credential ê°–ì¶˜ ìƒíƒœì—ì„œ ì¸ì¦í–ˆëŠ”ì§€ í™•ì¸</td>
    </tr>
  </tbody>
</table>

<h2 id="user-service-êµ¬í˜„">User Service êµ¬í˜„</h2>
<h4 id="custom-userdetailsservice">Custom UserDetailsService</h4>
<ul>
  <li>UserDetailsService class ì¬ì •ì˜</li>
</ul>

<h4 id="user-entity">User Entity</h4>
<ul>
  <li>UserDetails class ìƒì† ë°›ì•„ ì¶”ê°€ ì •ë³´ ì¬ì •ì˜</li>
</ul>

<h4 id="user-jpa-repository">User JPA Repository</h4>
<ul>
  <li>findByUid method ì¶”ê°€</li>
</ul>

<h4 id="signcontroller">SignController</h4>
<ul>
  <li>ì¸ì¦ ì„±ê³µì‹œ, ê²°ê³¼ë¡œ JWT token ë°œê¸‰</li>
  <li>ë¹„ë°€ë²ˆí˜¸ encoding ì„ ìœ„í•´ PasswordEncoder ì„¤ì •(ê¸°ë³¸ ì„¤ì •ì€ bcrypt encoding ì‚¬ìš©)
<strong><em>(Main Application class ì— PasswordEncoder Bean ì¶”ê°€)</em></strong></li>
</ul>

<h4 id="swagger-header-field-ì¶”ê°€">Swagger Header Field ì¶”ê°€</h4>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@ApiImplicitParams</span><span class="o">({</span>
  <span class="nd">@ApiImplicitParam</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"X-AUTH-TOKEN"</span><span class="o">,</span> <span class="n">value</span> <span class="o">=</span> <span class="s">"ì¸ì¦ ì„±ê³µ í›„ access_token"</span><span class="o">,</span> <span class="n">required</span> <span class="o">=</span> <span class="kc">true</span><span class="o">,</span> <span class="n">dataType</span> <span class="o">=</span> <span class="s">"String"</span><span class="o">,</span> <span class="n">paramType</span> <span class="o">=</span> <span class="s">"header"</span><span class="o">)</span>
<span class="o">})</span></code></pre></figure>

<hr />

<h2 id="ì¶”ê°€">ì¶”ê°€</h2>
<h4 id="ì˜ˆì™¸-ì²˜ë¦¬-ë³´ì™„">ì˜ˆì™¸ ì²˜ë¦¬ ë³´ì™„</h4>
<h5 id="ì˜ˆì™¸-ìƒí™©">ì˜ˆì™¸ ìƒí™©</h5>
<ol>
  <li>JWT token ì—†ì´ API ìš”ì²­í•œ ê²½ìš° <em>- 403 Access Denied ì—ëŸ¬</em></li>
  <li>í˜•ì‹ì— ë§ì§€ ì•Šê±°ë‚˜ ë§Œë£Œëœ JWT token ìœ¼ë¡œ API ìš”ì²­í•œ ê²½ìš° <em>- 403 Access Denied ì—ëŸ¬</em></li>
  <li>ìœ íš¨í•œ JWT token ì´ì§€ë§Œ, ê¶Œí•œì´ ì—†ëŠ” ê²½ìš° <em>- 403 Forbidden ì—ëŸ¬</em></li>
</ol>

<h5 id="403-access-denied-ì˜ˆì™¸-ì²˜ë¦¬">403 Access Denied ì˜ˆì™¸ ì²˜ë¦¬</h5>
<ul>
  <li>token ê²€ì¦ ë‹¨ê³„ì—ì„œ ì¸ì¦ ì²˜ë¦¬ê°€ ë¶ˆê°€ëŠ¥í•˜ê¸° ë•Œë¬¸ì— ëë‚˜ë²„ë¦¬ëŠ” í˜„ìƒ</li>
  <li>Spring Security ì—ì„œ ì œê³µí•˜ëŠ” AuthenticationEntryPoint ë¥¼ ìƒì† ë°›ì•„ redirect ì²˜ë¦¬</li>
</ul>

<h5 id="403-forbidden-ì˜ˆì™¸-ì²˜ë¦¬">403 Forbidden ì˜ˆì™¸ ì²˜ë¦¬</h5>
<ul>
  <li>token ëŠ” ì •ìƒì´ì§€ë§Œ ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ê¶Œí•œì´ ì—†ëŠ” ê²½ìš°</li>
  <li>Spring Security ì—ì„œ ì œê³µí•˜ëŠ” AccessDeniedHandler ë¥¼ ìƒì† ë°›ì•„ redirect ì²˜ë¦¬</li>
</ul>

<hr />

<h4 id="spring-security-ê´€ë ¨-ê¸°íƒ€-class-ë°-interface">Spring Security ê´€ë ¨ ê¸°íƒ€ Class ë° Interface</h4>
<h5 id="userdetails-interface">UserDetails Interface</h5>
<ul>
  <li>Spring Security ì—ì„œ ì‚¬ìš©ìì˜ ì •ë³´ë¥¼ ë‹´ëŠ” Interface</li>
  <li>User Entity ë¥¼ UserDetails ìƒì†ì„ ë°›ì•„ êµ¬í˜„</li>
</ul>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="kd">implements</span> <span class="nc">UserDetails</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="nc">String</span> <span class="n">userId</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">String</span> <span class="n">password</span><span class="o">;</span>
  <span class="o">...</span>

  <span class="cm">/**
   * Overiding method ë“¤ì€ Security í™˜ê²½ì—ì„œ ì‚¬ìš©í•˜ëŠ” íšŒì› ìƒíƒœê°’ì´ì§€ë§Œ,
   * ì‚¬ìš©í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ëª¨ë‘ "true" ì„¤ì •
   *
   * - isAccountNonExpired : ê³„ì •ì´ ë§Œë£Œ ì•ˆë˜ì—ˆëŠ”ì§€
   * - isAccountNonLocked : ê³„ì •ì´ ì ê¸´ ìƒíƒœì¸ì§€
   * - isCredentialsNonExpired : ê³„ì • ë¹„ë°€ë²ˆí˜¸ê°€ ë§Œë£Œëœ ìƒíƒœì¸ì§€
   * - isEnabled : ê³„ì •ì´ ì‚¬ìš© ê°€ëŠ¥í•œ ìƒíƒœì¸ì§€
   */</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isAccountNonExpired</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="kc">true</span><span class="o">;</span> <span class="o">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isAccountNonLocked</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="kc">true</span><span class="o">;</span> <span class="o">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isCredentialsNonExpired</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="kc">true</span><span class="o">;</span> <span class="o">}</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isEnabled</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="kc">true</span><span class="o">;</span> <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<h5 id="userdetailsservice-interface">UserDetailsService Interface</h5>
<ul>
  <li>DB ì—ì„œ ì‚¬ìš©ì ì •ë³´ë¥¼ ì¡°íšŒí•˜ëŠ” Interface</li>
  <li>loadUserByUsername() method ë¥¼ í†µí•´ UserDetails í˜•ìœ¼ë¡œ ì‚¬ìš©ì ì •ë³´ë¥¼ ì €ì¥</li>
</ul>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TokenProvider</span> <span class="o">{</span>
  <span class="o">...</span>
  <span class="kd">public</span> <span class="nc">Authentication</span> <span class="nf">getAuthentication</span><span class="o">(</span><span class="nc">String</span> <span class="n">userPk</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">UserDetails</span> <span class="n">userDetails</span> <span class="o">=</span> <span class="n">userDetailsService</span><span class="o">.</span><span class="na">loadUserByUsername</span><span class="o">(</span><span class="n">userPk</span><span class="o">);</span>

    <span class="cm">/**
     * UsernamePasswordAuthenticationToken.class
     * - AuthenticationFilter ë“±ë¡í•˜ê¸° ìœ„í•œ Authentication ì„ ìƒì„±í•´ì£¼ëŠ”
     *   Authentication Interface ì˜ êµ¬í˜„ì²´
     */</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">UsernamePasswordAuthenticationToken</span><span class="o">(</span><span class="n">userDetails</span><span class="o">,</span> <span class="s">""</span><span class="o">,</span> <span class="n">userDetails</span><span class="o">.</span><span class="na">getAuthorities</span><span class="o">());</span>
  <span class="o">}</span>
  <span class="o">...</span>
<span class="o">}</span></code></pre></figure>

<h5 id="simplegrantedauthority-class">SimpleGrantedAuthority Class</h5>
<ul>
  <li>Spring Security ì—ì„œ ì œê³µí•˜ëŠ” ê¶Œí•œ ê´€ë¦¬ Class</li>
  <li>ê¶Œí•œ ëª…ì¹­ë§Œ ì €ì¥í•˜ëŠ” êµ¬ì¡°ë¡œ ì„¤ê³„</li>
</ul>

<h5 id="passwordencoder-class">PasswordEncoder Class</h5>
<ul>
  <li>ë‹¨ë°©í–¥ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ Password ë¥¼ ì•ˆì „í•˜ê²Œ DBì— ì €ì¥í•  ìˆ˜ ìˆëŠ” Interface</li>
</ul>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PasswordEncoderTest</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="nc">PasswordEncoder</span> <span class="n">passwordEncoder</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">PasswordEncoderTest</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">passwordEncoder</span> <span class="o">=</span> <span class="nc">PasswordEncoderFactories</span><span class="o">.</span><span class="na">createDelegatingPasswordEncoder</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="n">password</span> <span class="o">=</span> <span class="s">"password"</span><span class="o">;</span>
    <span class="nc">String</span> <span class="n">encode</span> <span class="o">=</span> <span class="n">passwordEncoder</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">password</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">passwordEncoder</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="n">password</span><span class="o">,</span> <span class="n">encode</span><span class="o">))</span> <span class="o">{</span>
      <span class="c1">// True</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<hr />

<p><a href="https://github.com/JiYoonKimjimmy/demo-rest-api">ê´€ë ¨ Github Repository</a></p>
:ET