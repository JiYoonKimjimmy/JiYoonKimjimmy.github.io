I"ŠA<h2 id="spring-boot--aws-elasticache-for-redis">Spring Boot + AWS ElastiCache for Redis</h2>

<h3 id="aws-elasticache-for-redis-cluster-ìƒì„±">AWS ElastiCache for Redis Cluster ìƒì„±</h3>
<p>ìì„¸í•œ ë°©ë²•ì€ <a href="https://docs.aws.amazon.com/ko_kr/AmazonElastiCache/latest/red-ug/GettingStarted.CreateCluster.html">AWS ElastiCache ê°€ì´ë“œ ì°¸ê³ </a>.</p>
<h4 id="ìš”ì•½">ìš”ì•½</h4>
<ol>
  <li>VPC Subnet Group ìƒì„±</li>
  <li>Redis Cache Cluster ìƒì„±</li>
  <li>ë³´ì•ˆ ê·¸ë£¹ ì„¤ì •ì— Redis ê´€ë ¨ Port ì¶”ê°€</li>
</ol>

<h3 id="spring-boot--redis-ì—°ë™-ì„¤ì •">Spring Boot + Redis ì—°ë™ ì„¤ì •</h3>
<h4 id="redis-ê´€ë ¨-ì˜ì¡´ì„±-ì¶”ê°€">Redis ê´€ë ¨ ì˜ì¡´ì„± ì¶”ê°€</h4>
<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">implementation</span> <span class="s1">'org.springframework.boot:spring-boot-starter-data-redis'</span>
<span class="n">compile</span> <span class="nl">group:</span> <span class="s1">'redis.clients'</span><span class="o">,</span> <span class="nl">name:</span> <span class="s1">'jedis'</span><span class="o">,</span> <span class="nl">version:</span> <span class="s1">'3.3.0'</span>
</code></pre></div></div>
<h4 id="applicationyml-ìˆ˜ì •">application.yml ìˆ˜ì •</h4>
<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">spring</span><span class="pi">:</span>
  <span class="na">redis</span><span class="pi">:</span>
    <span class="na">host</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">AWS ElastiCache End-Point Host url</span><span class="pi">]</span>
    <span class="na">port</span><span class="pi">:</span> <span class="m">6379</span>
</code></pre></div></div>

<h4 id="redis-config-ì¶”ê°€">Redis Config ì¶”ê°€</h4>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RequiredArgsConstructor</span>
<span class="nd">@EnableRedisRepositories</span>
<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedisConfiguration</span> <span class="o">{</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${spring.redis.host}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">redisHost</span><span class="o">;</span>

    <span class="nd">@Value</span><span class="o">(</span><span class="s">"${spring.redis.port}"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">redisPort</span><span class="o">;</span>

    <span class="nd">@Bean</span>
    <span class="nc">JedisConnectionFactory</span> <span class="nf">jedisConnectionFactory</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">RedisStandaloneConfiguration</span> <span class="n">redisStandaloneConfiguration</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RedisStandaloneConfiguration</span><span class="o">(</span><span class="n">redisHost</span><span class="o">,</span> <span class="n">redisPort</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">JedisConnectionFactory</span><span class="o">(</span><span class="n">redisStandaloneConfiguration</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"redisTemplate"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">RedisTemplate</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="nf">redisTemplate</span><span class="o">(</span><span class="nc">RedisConnectionFactory</span> <span class="n">redisConnectionFactory</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">RedisTemplate</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Object</span><span class="o">&gt;</span> <span class="n">redisTemplate</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RedisTemplate</span><span class="o">&lt;&gt;();</span>

        <span class="n">redisTemplate</span><span class="o">.</span><span class="na">setConnectionFactory</span><span class="o">(</span><span class="n">redisConnectionFactory</span><span class="o">);</span>

        <span class="k">return</span> <span class="n">redisTemplate</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Primary</span>
    <span class="nd">@Bean</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"cacheManager"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="nc">CacheManager</span> <span class="nf">cacheManager</span><span class="o">(</span><span class="nc">RedisConnectionFactory</span> <span class="n">redisConnectionFactory</span><span class="o">)</span> <span class="o">{</span>
        <span class="cm">/**
         * Cache ê¸°ë³¸ ì„¤ì •
         */</span>
        <span class="nc">RedisCacheConfiguration</span> <span class="n">configuration</span> <span class="o">=</span> <span class="nc">RedisCacheConfiguration</span><span class="o">.</span><span class="na">defaultCacheConfig</span><span class="o">()</span>
                <span class="o">.</span><span class="na">disableCachingNullValues</span><span class="o">()</span>                                 <span class="c1">// Null Value ëŠ” Cache ì‚¬ìš©í•˜ì§€ ì•ŠìŒ</span>
                <span class="o">.</span><span class="na">entryTtl</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="nc">CacheKey</span><span class="o">.</span><span class="na">DEFAULT_EXPIRE_SEC</span><span class="o">))</span>  <span class="c1">// Cache ì˜ ê¸°ë³¸ ìœ íš¨ì‹œê°„ ì„¤ì •(60sec)</span>
                <span class="o">.</span><span class="na">computePrefixWith</span><span class="o">(</span><span class="nc">CacheKeyPrefix</span><span class="o">.</span><span class="na">simple</span><span class="o">())</span>                 <span class="c1">// Cache Key ì˜ Prefix ì„¤ì •(name + "::")</span>
                <span class="c1">// Redis Cache ë°ì´í„° ì €ì¥ë°©ì‹ì„ StringSerializer ë¡œ ì„¤ì •</span>
                <span class="o">.</span><span class="na">serializeKeysWith</span><span class="o">(</span><span class="nc">RedisSerializationContext</span><span class="o">.</span><span class="na">SerializationPair</span><span class="o">.</span><span class="na">fromSerializer</span><span class="o">(</span><span class="k">new</span> <span class="nc">StringRedisSerializer</span><span class="o">()));</span>

        <span class="cm">/**
         * Cache ìƒì„¸ ì„¤ì •
         * - Cache default expire ì‹œê°„ ì„¤ì •
         */</span>
        <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">RedisCacheConfiguration</span><span class="o">&gt;</span> <span class="n">cacheConfigurations</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>
        <span class="n">cacheConfigurations</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">CacheKey</span><span class="o">.</span><span class="na">USER</span><span class="o">,</span> <span class="nc">RedisCacheConfiguration</span><span class="o">.</span><span class="na">defaultCacheConfig</span><span class="o">().</span><span class="na">entryTtl</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="nc">CacheKey</span><span class="o">.</span><span class="na">USER_EXPIRE_SEC</span><span class="o">)));</span>
        <span class="n">cacheConfigurations</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="nc">CacheKey</span><span class="o">.</span><span class="na">BOARD</span><span class="o">,</span> <span class="nc">RedisCacheConfiguration</span><span class="o">.</span><span class="na">defaultCacheConfig</span><span class="o">().</span><span class="na">entryTtl</span><span class="o">(</span><span class="nc">Duration</span><span class="o">.</span><span class="na">ofSeconds</span><span class="o">(</span><span class="nc">CacheKey</span><span class="o">.</span><span class="na">BOARD_EXPIRE_SEC</span><span class="o">)));</span>

        <span class="k">return</span> <span class="nc">RedisCacheManager</span><span class="o">.</span><span class="na">RedisCacheManagerBuilder</span>
                <span class="o">.</span><span class="na">fromConnectionFactory</span><span class="o">(</span><span class="n">redisConnectionFactory</span><span class="o">)</span>
                <span class="o">.</span><span class="na">cacheDefaults</span><span class="o">(</span><span class="n">configuration</span><span class="o">)</span>
                <span class="o">.</span><span class="na">withInitialCacheConfigurations</span><span class="o">(</span><span class="n">cacheConfigurations</span><span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>

    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<h3 id="entity-redis-ì„¤ì •">Entity Redis ì„¤ì •</h3>
<h4 id="caching-ê°ì²´-serializable">Caching ê°ì²´ Serializable</h4>
<h5 id="caching-ê°ì²´-serializable-í•˜ëŠ”-ì´ìœ ">Caching ê°ì²´ Serializable í•˜ëŠ” ì´ìœ </h5>
<ul>
  <li><code class="language-plaintext highlighter-rouge">Redis</code>ì— ê°ì²´ë¥¼ ì €ì¥í•˜ë©´ ë‚´ë¶€ì ìœ¼ë¡œ ì§ë ¬í™”í•˜ì—¬ ì €ì¥</li>
  <li><code class="language-plaintext highlighter-rouge">Entity</code>ì— <code class="language-plaintext highlighter-rouge">Serializable</code>ì„ ì„ ì–¸í•˜ì§€ ì•Šìœ¼ë©´ ì˜¤ë¥˜ ë°œìƒ ê°€ëŠ¥
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Board</span> <span class="kd">implements</span> <span class="nc">Serializable</span> <span class="o">{</span>
<span class="o">...</span>
<span class="o">}</span>
</code></pre></div>    </div>
    <h4 id="lazy-loading-false">Lazy Loading False</h4>
    <h5 id="lazy-loading-false-ì²˜ë¦¬-í•˜ëŠ”-ì´ìœ ">Lazy Loading false ì²˜ë¦¬ í•˜ëŠ” ì´ìœ </h5>
  </li>
  <li>Entity ê°ì²´ë‚´ì—ì„œ ì—°ê´€ê´€ê³„ Mappingì— ì˜í•´ Lazy(ì§€ì—°) Loading ë˜ëŠ” ê²½ìš° ì˜¤ë¥˜ ë°œìƒ ê°€ëŠ¥
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Proxy</span><span class="o">(</span><span class="n">lazy</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="kd">implements</span> <span class="nc">Serializable</span> <span class="o">{</span>
<span class="o">...</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="crud-methods-caching-ì²˜ë¦¬">CRUD Methods Caching ì²˜ë¦¬</h3>
<p><strong>Caching ì²˜ë¦¬ ê´€ë ¨ Annotation</strong>
| Annotation | ì„¤ëª… |
| :â€”: | â€” |
| <code class="language-plaintext highlighter-rouge">@Cacheable</code> | <code class="language-plaintext highlighter-rouge">Cache</code>ê°€ ì¡´ì¬í•˜ë©´ ìš”ì²­ëœ <code class="language-plaintext highlighter-rouge">Method</code>ë¥¼ ì‹¤í–‰í•˜ì§€ ì•Šê³  <code class="language-plaintext highlighter-rouge">Cache</code>ë°ì´í„°ë¥¼ ë°˜í™˜ ì²˜ë¦¬ |
| <code class="language-plaintext highlighter-rouge">@CachePut</code> | <code class="language-plaintext highlighter-rouge">Cache</code>ì— ë°ì´í„°ë¥¼ ë„£ê±°ë‚˜ ìˆ˜ì •ì‹œ ì‚¬ìš©. <code class="language-plaintext highlighter-rouge">Method</code>ì˜ ë°˜í™˜ê°’ì´ <code class="language-plaintext highlighter-rouge">Cache</code>ì— ì—†ìœ¼ë©´ ì €ì¥í•˜ê³ , ìˆëŠ” ê²½ìš°ì—” ê°±ì‹  ì²˜ë¦¬ |
| <code class="language-plaintext highlighter-rouge">@CacheEvict</code> | <code class="language-plaintext highlighter-rouge">Cache</code> ì‚­ì œ |
| <code class="language-plaintext highlighter-rouge">@Caching</code> | ì—¬ëŸ¬ê°œì˜ <code class="language-plaintext highlighter-rouge">Cache Annotation</code>ì„ ì‹¤í–‰ë˜ì–´ì•¼ í•  ë•Œ ì‚¬ìš© |</p>

<h5 id="annotation-ì˜µì…˜-ì„¤ëª…">Annotation ì˜µì…˜ ì„¤ëª…</h5>
<ul>
  <li><code class="language-plaintext highlighter-rouge">value = CacheKey.BOARD</code> : ì €ì¥ì‹œ ì‚¬ìš©ë˜ëŠ” Key Name</li>
  <li><code class="language-plaintext highlighter-rouge">key = "#id"</code> : <code class="language-plaintext highlighter-rouge">value</code> ì˜µì…˜ì—ì„œ ì„ ì–¸ëœ Key Name ê³¼ ê²°í•© <strong><em>(ex. â€˜board::1â€™)</em></strong></li>
  <li><code class="language-plaintext highlighter-rouge">unless = "#result == null"</code> : ê²°ê³¼ê°€ <code class="language-plaintext highlighter-rouge">null</code> ì´ ì•„ë‹Œ ê²½ìš°ë§Œ Caching ì²˜ë¦¬</li>
  <li><code class="language-plaintext highlighter-rouge">condition = "#id &gt; 10"</code> : ê°„ë‹¨í•œ ì¡°ê±´ë¬¸ì— ë”°ë¼ Caching ì²˜ë¦¬</li>
</ul>

<h3 id="cache-ì²˜ë¦¬ì˜-ë˜ë‹¤ë¥¸-ë°©ë²•-cacheservice-ì¶”ê°€">Cache ì²˜ë¦¬ì˜ ë˜ë‹¤ë¥¸ ë°©ë²•. CacheService ì¶”ê°€</h3>
<ul>
  <li><code class="language-plaintext highlighter-rouge">Caching</code> ì²˜ë¦¬í•´ì£¼ëŠ” Service</li>
  <li>ì™œ <code class="language-plaintext highlighter-rouge">CacheService</code>ê°€ í•„ìš”í•œê°€?
    <ul>
      <li>ìš”ì²­ë°›ì€ <code class="language-plaintext highlighter-rouge">Method</code>ì˜ ì¸ìê°’ìœ¼ë¡œ <code class="language-plaintext highlighter-rouge">Cache Key</code>ë¥¼ ì¡°í•©í•  ìˆ˜ ì—†ì„ ë•Œê°€ ìˆê¸° ë•Œë¬¸</li>
      <li><code class="language-plaintext highlighter-rouge">Proxy</code>ì˜ íŠ¹ì„±ìƒ ê°™ì€ ê°ì²´ë‚´ì—ì„œëŠ” <code class="language-plaintext highlighter-rouge">Caching</code>ì²˜ë¦¬ëœ <code class="language-plaintext highlighter-rouge">Method</code> í˜¸ì¶œì‹œ ë™ì‘í•˜ì§€ ì•Šê¸° ë•Œë¬¸</li>
    </ul>
  </li>
</ul>

<h3 id="custom-key-generator">Custom Key Generator</h3>
<h4 id="customkeygeneratorjava">CustomKeyGenerator.java</h4>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomKeyGenerator</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Object</span> <span class="nf">create</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o1</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"FRONT:"</span> <span class="o">+</span> <span class="n">o1</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Object</span> <span class="nf">create</span><span class="o">(</span><span class="nc">Object</span> <span class="n">o1</span><span class="o">,</span> <span class="nc">Object</span> <span class="n">o2</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">"FRONT:"</span> <span class="o">+</span> <span class="n">o1</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="n">o2</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h4 id="customkeygenerator-ì´ìš©í•œ-caching">CustomKeyGenerator ì´ìš©í•œ Caching</h4>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Cacheable</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="nc">CacheKey</span><span class="o">.</span><span class="na">BOARD</span><span class="o">,</span> <span class="n">key</span> <span class="o">=</span> <span class="s">"T(com.demo.restapi.config.redis.CustomKeyGenerator).create(#id)"</span><span class="o">,</span> <span class="n">unless</span> <span class="o">=</span> <span class="s">"#result == null"</span><span class="o">)</span>
</code></pre></div></div>

<hr />

<blockquote>
  <p><strong>Reference</strong>
<a href="https://keyholesoftware.com/2018/08/28/using-amazon-elasticache-for-redis-to-optimize-your-spring-boot-application/">keyholesoftware.com [Using Amazon ElastiCache For Redis]</a></p>
</blockquote>
:ET